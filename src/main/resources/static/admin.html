<!DOCTYPE html>
<html lang="es" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Ana & Luis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;500;600&display=swap');
        :root {
            --grey-cotton: #E5E7EB;
            --seedling: #82907E;
            --evergreen: #2D3A2F;
            --ebony: #111111;
            --white-bone: #F9FAFB;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--white-bone);
            color: var(--evergreen);
        }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .text-ebony { color: var(--ebony); }
        .text-evergreen { color: var(--evergreen); }
        .text-seedling { color: var(--seedling); }
        .bg-seedling { background-color: var(--seedling); }
        .bg-evergreen { background-color: var(--evergreen); }
        .bg-grey-cotton { background-color: var(--grey-cotton); }
        .border-seedling { border-color: var(--seedling); }
        .border-grey-cotton { border-color: var(--grey-cotton); }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(45, 58, 47, 0.08);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 17, 17, 0.7);
            backdrop-filter: blur(4px);
        }
        .modal.active { display: flex; align-items: center; justify-center; }
        .tab-button.active {
            background-color: var(--seedling);
            color: white;
        }
        .filter-btn.active {
            background-color: var(--seedling) !important;
            color: white !important;
        }
        .filter-btn:hover {
            background-color: var(--evergreen);
            color: white;
        }
        .message-card {
            border-left: 3px solid var(--seedling);
            background: white;
            transition: all 0.3s ease;
        }
        .message-card:hover {
            box-shadow: 0 4px 12px rgba(45, 58, 47, 0.12);
            transform: translateX(4px);
        }
        .fab-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background-color: var(--seedling);
            color: white;
            box-shadow: 0 8px 24px rgba(130, 144, 126, 0.4);
            display: flex;
            align-items: center;
            justify-center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 50;
        }
        .fab-button:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(130, 144, 126, 0.5);
        }
    </style>
</head>
<body class="antialiased pb-24">
    <header class="bg-evergreen text-white sticky top-0 z-40 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
            <div class="text-center">
                <h1 class="font-playfair text-3xl md:text-4xl mb-2">Panel de Control</h1>
                <p class="text-sm opacity-80">Ana Gabriela & Luis Manuel</p>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
        <div class="flex gap-2 mb-8 overflow-x-auto pb-2">
            <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-button active px-6 py-3 rounded-full font-medium whitespace-nowrap transition-all bg-grey-cotton">
                üìä Dashboard
            </button>
            <button onclick="showTab('invitados')" id="tab-invitados" class="tab-button px-6 py-3 rounded-full font-medium whitespace-nowrap transition-all bg-grey-cotton">
                üë• Invitados
            </button>
            <button onclick="showTab('mensajes')" id="tab-mensajes" class="tab-button px-6 py-3 rounded-full font-medium whitespace-nowrap transition-all bg-grey-cotton">
                üíå Mensajes
            </button>
        </div>

        <div id="content-dashboard" class="tab-content">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="card p-6 text-center" data-aos="fade-up">
                    <div class="text-4xl mb-2">üë•</div>
                    <p class="text-sm text-evergreen opacity-70 mb-1">Familias</p>
                    <p id="metric-total" class="text-3xl font-playfair text-ebony">0</p>
                </div>
                <div class="card p-6 text-center" data-aos="fade-up" data-aos-delay="100">
                    <div class="text-4xl mb-2">‚úì</div>
                    <p class="text-sm text-evergreen opacity-70 mb-1">Confirmados</p>
                    <p id="metric-confirmados" class="text-3xl font-playfair text-seedling">0</p>
                </div>
                <div class="card p-6 text-center" data-aos="fade-up" data-aos-delay="200">
                    <div class="text-4xl mb-2">üé´</div>
                    <p class="text-sm text-evergreen opacity-70 mb-1">Pases</p>
                    <p id="metric-pases" class="text-2xl font-playfair text-ebony">0/0</p>
                </div>
                <div class="card p-6 text-center" data-aos="fade-up" data-aos-delay="300">
                    <div class="text-4xl mb-2">üìä</div>
                    <p class="text-sm text-evergreen opacity-70 mb-1">Asistencia</p>
                    <p id="metric-porcentaje" class="text-3xl font-playfair text-seedling">0%</p>
                </div>
            </div>

            <div class="card p-6" data-aos="fade-up">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <h2 class="font-playfair text-2xl text-ebony">Resumen de Confirmaciones</h2>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="downloadLista()" class="px-4 py-2 rounded-full text-sm font-medium transition-all bg-evergreen text-white hover:bg-seedling">
                            üì• Descargar Lista
                        </button>
                        <button onclick="filterSummary('all')" id="filter-all" class="filter-btn active px-4 py-2 rounded-full text-sm font-medium transition-all bg-seedling text-white">
                            Todos
                        </button>
                        <button onclick="filterSummary('confirmado')" id="filter-confirmado" class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all bg-grey-cotton text-evergreen">
                            Confirmados
                        </button>
                        <button onclick="filterSummary('pendiente')" id="filter-pendiente" class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all bg-grey-cotton text-evergreen">
                            Pendientes
                        </button>
                    </div>
                </div>
                <div class="space-y-3" id="summary-list">
                </div>
            </div>
        </div>

        <div id="content-invitados" class="tab-content hidden">
            <div class="space-y-4" id="invitados-list">
            </div>
        </div>

        <div id="content-mensajes" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="font-playfair text-3xl text-ebony mb-2">Diario de Mensajes</h2>
                <p class="text-evergreen opacity-70">Lo que las familias nos escribieron</p>
            </div>
            <div class="space-y-6" id="mensajes-list">
            </div>
        </div>
    </main>

    <button onclick="showAddModal()" class="fab-button">
        +
    </button>

    <div id="modal-form" class="modal">
        <div class="bg-white rounded-2xl max-w-2xl w-full mx-4 p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="font-playfair text-3xl text-ebony mb-6 text-center">Agregar Invitado</h3>
            <form id="invitado-form" class="space-y-4">
                <input type="hidden" id="invitado-id">
                <div>
                    <label class="block text-sm font-medium text-evergreen mb-2">Nombre de Familia</label>
                    <input type="text" id="nombreFamilia" required 
                           class="w-full px-4 py-3 border border-grey-cotton rounded-lg focus:ring-2 focus:ring-seedling focus:border-transparent"
                           placeholder="Familia P√©rez">
                </div>
                <div>
                    <label class="block text-sm font-medium text-evergreen mb-2">Slug (para URL)</label>
                    <input type="text" id="slug" required 
                           class="w-full px-4 py-3 border border-grey-cotton rounded-lg focus:ring-2 focus:ring-seedling focus:border-transparent"
                           placeholder="familia-perez">
                    <p class="text-xs text-evergreen opacity-60 mt-1">Solo min√∫sculas, n√∫meros y guiones</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-evergreen mb-2">Tel√©fono (con c√≥digo)</label>
                    <input type="text" id="telefono" 
                           class="w-full px-4 py-3 border border-grey-cotton rounded-lg focus:ring-2 focus:ring-seedling focus:border-transparent"
                           placeholder="+52123456789">
                </div>
                <div>
                    <label class="block text-sm font-medium text-evergreen mb-2">N√∫mero de Pases</label>
                    <input type="number" id="pasesTotales" required min="1" 
                           class="w-full px-4 py-3 border border-grey-cotton rounded-lg focus:ring-2 focus:ring-seedling focus:border-transparent"
                           placeholder="4"
                           onchange="updatePersonasFieldsPreservingData()">
                </div>
                
                <!-- Gesti√≥n de nombres de invitados espec√≠ficos -->
                <div id="personas-section" class="hidden">
                    <div class="border-t border-grey-cotton pt-4 mt-4">
                        <label class="block text-sm font-medium text-evergreen mb-2 flex items-center gap-2">
                            <svg class="w-5 h-5 text-seedling" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Nombres de Invitados Espec√≠ficos
                            <span class="text-xs opacity-70">(opcional)</span>
                        </label>
                        <p class="text-xs text-evergreen opacity-60 mb-3">
                            Agrega los nombres de las personas que S√ç quieres que asistan. Los pases sin nombre quedar√°n disponibles para que el invitado los complete.
                        </p>
                        <div id="personas-list" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Secci√≥n de personas adicionales (agregadas por invitados) -->
                <div id="personas-adicionales-section" class="hidden">
                    <div class="border-t border-grey-cotton pt-4 mt-4">
                        <label class="block text-sm font-medium text-evergreen mb-2 flex items-center gap-2">
                            <svg class="w-5 h-5 text-seedling" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Pases Adicionales Agregados
                            <span class="text-xs bg-seedling text-white px-2 py-0.5 rounded-full">(Agregados por invitados)</span>
                        </label>
                        <p class="text-xs text-evergreen opacity-60 mb-3">
                            Estos pases fueron agregados por los invitados. Solo puedes verlos, no modificarlos.
                        </p>
                        <div id="personas-adicionales-list" class="space-y-2 bg-grey-cotton rounded-lg p-3"></div>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-seedling text-white px-6 py-3 rounded-full font-medium hover:bg-evergreen transition-all">
                        Guardar
                    </button>
                    <button type="button" onclick="closeModal()" 
                            class="flex-1 bg-grey-cotton text-evergreen px-6 py-3 rounded-full font-medium hover:bg-evergreen hover:text-white transition-all">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        const API_BASE='/api/admin';
        const APP_URL=window.location.origin;
        let invitados=[];
        AOS.init({duration:800,once:true});

        document.addEventListener('DOMContentLoaded',()=>{
            loadData();
            document.getElementById('invitado-form').addEventListener('submit',handleSubmit);
        });

        function showTab(tab){
            document.querySelectorAll('.tab-content').forEach(el=>el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el=>el.classList.remove('active'));
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        async function loadData(){
            try{
                const invitadosRes=await fetch(`${API_BASE}/invitados`);
                invitados=await invitadosRes.json();
                renderInvitados();
                renderMensajes();
                const metricsRes=await fetch(`${API_BASE}/metrics`);
                const metrics=await metricsRes.json();
                updateMetrics(metrics);
            }catch(error){
                console.error('Error:',error);
                alert('Error al cargar datos');
            }
        }

        function updateMetrics(metrics){
            document.getElementById('metric-total').textContent=metrics.totalInvitados;
            document.getElementById('metric-confirmados').textContent=metrics.familiasConfirmadas;
            document.getElementById('metric-pases').textContent=`${metrics.pasesConfirmados}/${metrics.totalPases}`;
            document.getElementById('metric-porcentaje').textContent=`${Math.round(metrics.porcentajeConfirmacion)}%`;
            
            renderSummary('all');
        }

        function filterSummary(filter){
            document.querySelectorAll('.filter-btn').forEach(btn=>btn.classList.remove('active'));
            document.getElementById(`filter-${filter}`).classList.add('active');
            renderSummary(filter);
        }

        function renderSummary(filter){
            let filteredInvitados = invitados;
            
            if(filter === 'confirmado'){
                filteredInvitados = invitados.filter(inv => inv.confirmado);
            } else if(filter === 'pendiente'){
                filteredInvitados = invitados.filter(inv => !inv.confirmado);
            }
            
            const summaryList=document.getElementById('summary-list');
            
            if(filteredInvitados.length === 0){
                summaryList.innerHTML=`
                    <div class="text-center py-8 text-evergreen opacity-60">
                        <p>No hay invitados en esta categor√≠a</p>
                    </div>
                `;
                return;
            }
            
            summaryList.innerHTML=filteredInvitados.map(inv=>{
                // Solo mostrar personas ACTIVAS y CONFIRMADAS
                const personasConfirmadas = inv.personas && inv.personas.length > 0 
                    ? inv.personas.filter(p => p.activo !== false && p.confirmado)
                    : [];
                    
                const nombres = personasConfirmadas.length > 0
                    ? personasConfirmadas.map(p => p.nombreCompleto).join(', ')
                    : 'Nombres no especificados';
                    
                return `
                <div class="py-3 border-b border-grey-cotton last:border-0">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="font-medium text-evergreen">${inv.nombreFamilia}</p>
                            <p class="text-xs text-evergreen opacity-60">${inv.slug}</p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${inv.confirmado?'bg-seedling text-white':'bg-grey-cotton text-evergreen'}">
                                ${inv.confirmado?`${inv.pasesConfirmados} confirmados`:'Pendiente'}
                            </span>
                        </div>
                    </div>
                    ${inv.confirmado && personasConfirmadas.length > 0 ? `
                        <div class="pl-4 border-l-2 border-seedling mt-2">
                            <p class="text-xs text-evergreen opacity-70 mb-1">Invitados confirmados:</p>
                            <p class="text-sm text-evergreen">${nombres}</p>
                        </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        function renderInvitados(){
            const list=document.getElementById('invitados-list');
            list.innerHTML=invitados.map(inv=>`
                <div class="card p-4" data-aos="fade-up">
                    <div class="flex items-start gap-4">
                        <div class="flex-1">
                            <h3 class="font-playfair text-xl text-ebony mb-1">${inv.nombreFamilia}</h3>
                            <p class="text-sm text-evergreen opacity-70 mb-2 font-mono">${inv.slug}</p>
                            <div class="flex flex-wrap gap-2 text-sm">
                                <span class="px-3 py-1 rounded-full bg-grey-cotton">
                                    üé´ ${inv.pasesTotales} pases
                                </span>
                                ${inv.confirmado?`<span class="px-3 py-1 rounded-full bg-seedling text-white">‚úì ${inv.pasesConfirmados} confirmados</span>`:'<span class="px-3 py-1 rounded-full bg-grey-cotton text-evergreen">Pendiente</span>'}
                                ${inv.telefono?`<span class="px-3 py-1 rounded-full bg-grey-cotton">üì± ${inv.telefono}</span>`:''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            ${inv.telefono?`
                                <button onclick="sendWhatsApp('${inv.telefono}','${inv.slug}','${inv.nombreFamilia}',${inv.pasesTotales})" 
                                    class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center hover:bg-green-600 transition-all" title="Enviar invitaci√≥n">
                                    üì±
                                </button>
                                ${inv.confirmado?`
                                    <button onclick="sendReconfirmacion('${inv.telefono}','${inv.slug}','${inv.nombreFamilia}',${inv.pasesConfirmados},${inv.pasesTotales})" 
                                        class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center hover:bg-blue-600 transition-all" title="Reconfirmar asistencia">
                                        üîî
                                    </button>
                                `:``}
                            `:''}
                            <button onclick="copyLink('${inv.slug}')" 
                                class="w-10 h-10 rounded-full bg-seedling text-white flex items-center justify-center hover:bg-evergreen transition-all" title="Copiar link">üîó</button>
                            <button onclick="editInvitado(${inv.id})" 
                                class="w-10 h-10 rounded-full bg-grey-cotton text-evergreen flex items-center justify-center hover:bg-evergreen hover:text-white transition-all" title="Editar">‚úèÔ∏è</button>
                            <button onclick="deleteInvitado(${inv.id},'${inv.nombreFamilia}')" 
                                class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderMensajes(){
            const mensajesConTexto=invitados.filter(inv=>inv.mensaje&&inv.mensaje.trim()!=='');
            const list=document.getElementById('mensajes-list');
            
            if(mensajesConTexto.length===0){
                list.innerHTML=`
                    <div class="card p-12 text-center">
                        <div class="text-6xl mb-4 opacity-30">üíå</div>
                        <p class="font-playfair text-2xl text-evergreen mb-2">A√∫n no hay mensajes</p>
                        <p class="text-sm text-evergreen opacity-60">Los mensajes de las familias aparecer√°n aqu√≠</p>
                    </div>
                `;
                return;
            }

            list.innerHTML=mensajesConTexto.map((inv,index)=>`
                <div class="message-card p-6 rounded-lg" data-aos="fade-up" data-aos-delay="${index*50}">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-full bg-seedling text-white flex items-center justify-center font-playfair text-xl flex-shrink-0">
                            ${inv.nombreFamilia.charAt(0)}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <h3 class="font-playfair text-xl text-ebony">${inv.nombreFamilia}</h3>
                                    <p class="text-sm text-evergreen opacity-60">
                                        ${inv.confirmado?`Confirm√≥ ${inv.pasesConfirmados} de ${inv.pasesTotales} pases`:`${inv.pasesTotales} pases disponibles`}
                                    </p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${inv.confirmado?'bg-seedling text-white':'bg-grey-cotton text-evergreen'}">
                                    ${inv.confirmado?'Confirmado':'Pendiente'}
                                </span>
                            </div>
                            <div class="bg-grey-cotton rounded-lg p-4">
                                <p class="text-evergreen italic leading-relaxed">"${inv.mensaje}"</p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function sendWhatsApp(telefono,slug,nombreFamilia,pasesTotales){
            const link=`${APP_URL}/?id=${slug}`;
            const esSingular = pasesTotales === 1;
            const mensaje = esSingular
                ? `üåø ${nombreFamilia}, te hacemos llegar nuestra invitaci√≥n digital para que nos acompa√±es en la celebraci√≥n de nuestra uni√≥n el pr√≥ximo 27 de junio de 2026:\n\nüîó ${link}\n\nDentro podr√°s consultar el itinerario, la ubicaci√≥n y confirmar tu asistencia. Te esperamos con mucho cari√±o.`
                : `üåø ${nombreFamilia}, les hacemos llegar nuestra invitaci√≥n digital para que nos acompa√±en en la celebraci√≥n de nuestra uni√≥n el pr√≥ximo 27 de junio de 2026:\n\nüîó ${link}\n\nDentro podr√°n consultar el itinerario, la ubicaci√≥n y confirmar el n√∫mero de pases que utilizar√°n. Los esperamos con mucho cari√±o.`;
            const whatsappUrl=`https://wa.me/${telefono.replace(/\D/g,'')}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl,'_blank');
        }

        function sendReconfirmacion(telefono,slug,nombreFamilia,pasesConfirmados,pasesTotales){
            const link=`${APP_URL}/?id=${slug}`;
            const esSingular = pasesTotales === 1;
            const mensaje = esSingular
                ? `${nombreFamilia}, üåø\n\nFaltan solo unas semanas para nuestra boda y queremos confirmar nuevamente tu asistencia.\n\nActualmente tienes confirmado ${pasesConfirmados} pase. Si necesitas modificarlo, puedes hacerlo en:\n\nüîó ${link}\n\n¬°Te esperamos con mucha ilusi√≥n el 27 de junio!`
                : `${nombreFamilia}, üåø\n\nFaltan solo unas semanas para nuestra boda y queremos confirmar nuevamente su asistencia.\n\nActualmente tienen confirmados ${pasesConfirmados} pases. Si necesitan modificar el n√∫mero de invitados, pueden hacerlo en:\n\nüîó ${link}\n\n¬°Los esperamos con mucha ilusi√≥n el 27 de junio!`;
            const whatsappUrl=`https://wa.me/${telefono.replace(/\D/g,'')}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl,'_blank');
        }

        function copyLink(slug){
            const link=`${APP_URL}/?id=${slug}`;
            navigator.clipboard.writeText(link).then(()=>{
                alert('¬°Link copiado al portapapeles!');
            });
        }

        function showAddModal(){
            document.getElementById('modal-title').textContent='Agregar Invitado';
            document.getElementById('invitado-form').reset();
            document.getElementById('invitado-id').value='';
            document.getElementById('personas-section').classList.add('hidden');
            document.getElementById('modal-form').classList.add('active');
        }

        function editInvitado(id){
            const inv=invitados.find(i=>i.id===id);
            if(!inv)return;
            document.getElementById('modal-title').textContent='Editar Invitado';
            document.getElementById('invitado-id').value=inv.id;
            document.getElementById('nombreFamilia').value=inv.nombreFamilia;
            document.getElementById('slug').value=inv.slug;
            document.getElementById('telefono').value=inv.telefono||'';
            document.getElementById('pasesTotales').value=inv.pasesTotales;
            
            // Cargar personas espec√≠ficas ACTIVAS (esAdicional = false, activo = true)
            const personasEspecificas = inv.personas 
                ? inv.personas.filter(p => !p.esAdicional && p.activo !== false) 
                : [];
            
            // Cargar personas adicionales ACTIVAS (esAdicional = true, activo = true)
            const personasAdicionales = inv.personas 
                ? inv.personas.filter(p => p.esAdicional && p.activo !== false) 
                : [];
            
            updatePersonasFields(personasEspecificas);
            renderPersonasAdicionales(personasAdicionales);
            
            document.getElementById('modal-form').classList.add('active');
        }
        
        function renderPersonasAdicionales(adicionales) {
            const section = document.getElementById('personas-adicionales-section');
            const list = document.getElementById('personas-adicionales-list');
            
            if (adicionales.length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            list.innerHTML = '';
            
            adicionales.forEach(persona => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 p-2 rounded bg-white';
                div.innerHTML = `
                    <svg class="w-4 h-4 text-seedling flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m7 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-evergreen">${persona.nombreCompleto}</p>
                        <p class="text-xs text-evergreen opacity-60">Agregado por invitado ‚Ä¢ Confirmado</p>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        
        function updatePersonasFields(existingPersonas = []){
            const pasesTotales = parseInt(document.getElementById('pasesTotales').value) || 0;
            
            if (pasesTotales === 0) {
                document.getElementById('personas-section').classList.add('hidden');
                return;
            }
            
            document.getElementById('personas-section').classList.remove('hidden');
            const list = document.getElementById('personas-list');
            list.innerHTML = '';
            
            for (let i = 0; i < pasesTotales; i++) {
                const persona = existingPersonas[i];
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `
                    <input type="hidden" class="persona-id" value="${persona ? persona.id : ''}">
                    <span class="flex-shrink-0 w-8 h-8 rounded-full bg-grey-cotton flex items-center justify-center text-xs font-medium text-evergreen">
                        ${i + 1}
                    </span>
                    <input type="text" 
                           class="persona-nombre flex-1 px-3 py-2 border border-grey-cotton rounded-lg text-sm focus:ring-2 focus:ring-seedling focus:border-transparent" 
                           placeholder="Nombre completo (opcional)"
                           value="${persona ? persona.nombreCompleto : ''}">
                    <button type="button" 
                            onclick="clearPersonaField(${i})"
                            class="w-8 h-8 rounded-full bg-red-100 text-red-600 hover:bg-red-500 hover:text-white transition-all text-xs flex-shrink-0">
                        ‚úï
                    </button>
                `;
                list.appendChild(div);
            }
        }
        
        function updatePersonasFieldsPreservingData(){
            const pasesTotales = parseInt(document.getElementById('pasesTotales').value) || 0;
            
            if (pasesTotales === 0) {
                document.getElementById('personas-section').classList.add('hidden');
                return;
            }
            
            document.getElementById('personas-section').classList.remove('hidden');
            const list = document.getElementById('personas-list');
            
            // Leer los datos actuales del DOM
            const currentInputs = list.querySelectorAll('.persona-nombre');
            const currentIds = list.querySelectorAll('.persona-id');
            const currentData = [];
            
            currentInputs.forEach((input, index) => {
                currentData.push({
                    id: currentIds[index] ? currentIds[index].value : '',
                    nombre: input.value.trim()
                });
            });
            
            // Limpiar y regenerar
            list.innerHTML = '';
            
            for (let i = 0; i < pasesTotales; i++) {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                
                // Usar datos existentes si est√°n disponibles, sino vac√≠o
                const currentValue = currentData[i];
                const nombre = currentValue ? currentValue.nombre : '';
                const id = currentValue ? currentValue.id : '';
                
                div.innerHTML = `
                    <input type="hidden" class="persona-id" value="${id}">
                    <span class="flex-shrink-0 w-8 h-8 rounded-full bg-grey-cotton flex items-center justify-center text-xs font-medium text-evergreen">
                        ${i + 1}
                    </span>
                    <input type="text" 
                           class="persona-nombre flex-1 px-3 py-2 border border-grey-cotton rounded-lg text-sm focus:ring-2 focus:ring-seedling focus:border-transparent" 
                           placeholder="Nombre completo (opcional)"
                           value="${nombre}">
                    <button type="button" 
                            onclick="clearPersonaField(${i})"
                            class="w-8 h-8 rounded-full bg-red-100 text-red-600 hover:bg-red-500 hover:text-white transition-all text-xs flex-shrink-0">
                        ‚úï
                    </button>
                `;
                list.appendChild(div);
            }
        }
        
        function clearPersonaField(index){
            const inputs = document.querySelectorAll('.persona-nombre');
            if (inputs[index]) {
                inputs[index].value = '';
            }
        }

        function closeModal(){
            document.getElementById('modal-form').classList.remove('active');
        }

        async function handleSubmit(e){
            e.preventDefault();
            const id=document.getElementById('invitado-id').value;
            const invitado={
                nombreFamilia:document.getElementById('nombreFamilia').value,
                slug:document.getElementById('slug').value,
                telefono:document.getElementById('telefono').value,
                pasesTotales:parseInt(document.getElementById('pasesTotales').value),
                pasesConfirmados:0,
                confirmado:false,
                mensaje:''
            };
            
            // Recopilar nombres de personas
            const personasNombres = [];
            const personasIds = [];
            document.querySelectorAll('.persona-nombre').forEach((input, index) => {
                const nombre = input.value.trim();
                const personaId = document.querySelectorAll('.persona-id')[index].value;
                
                if (nombre) {
                    personasNombres.push({
                        id: personaId ? parseInt(personaId) : null,
                        nombreCompleto: nombre,
                        orden: index + 1
                    });
                }
            });
            
            invitado.personas = personasNombres;
            
            try{
                let response;
                if(id){
                    response=await fetch(`${API_BASE}/invitados/${id}`,{
                        method:'PUT',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify(invitado)
                    });
                }else{
                    response=await fetch(`${API_BASE}/invitados`,{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify(invitado)
                    });
                }
                if(response.ok){
                    closeModal();
                    loadData();
                    alert('¬°Invitado guardado!');
                }else{
                    const error=await response.json();
                    alert(error.error||'Error al guardar');
                }
            }catch(error){
                console.error('Error:',error);
                alert('Error al guardar invitado');
            }
        }

        async function deleteInvitado(id,nombre){
            if(!confirm(`¬øEliminar a ${nombre}?`))return;
            try{
                const response=await fetch(`${API_BASE}/invitados/${id}`,{method:'DELETE'});
                if(response.ok){
                    loadData();
                    alert('Invitado eliminado');
                }else{
                    alert('Error al eliminar');
                }
            }catch(error){
                console.error('Error:',error);
                alert('Error al eliminar invitado');
            }
        }
        
        function downloadLista(){
            window.open(`${API_BASE}/export-lista`, '_blank');
        }
    </script>
</body>
</html>